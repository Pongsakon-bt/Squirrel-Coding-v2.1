<!DOCTYPE html>
<html lang="th" style="height: 100%;">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Squirrel Coding: Adventure in the Forest</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Kanit:wght@300;400;600;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- MediaPipe Libraries -->
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/control_utils/control_utils.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/drawing_utils/drawing_utils.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/hands/hands.js" crossorigin="anonymous"></script>

    <style>
        body { font-family: 'Kanit', sans-serif; overflow: hidden; background-color: #ecfccb; height: 100%; margin: 0; }
        .mirror-mode { transform: scaleX(-1); }
        .grid-cell { transition: all 0.3s ease; box-shadow: inset 0 -4px 0 rgba(0,0,0,0.1); }
        .squirrel-container { z-index: 20; transition: top 0.5s linear, left 0.5s linear; }
        .squirrel-body { transition: transform 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275); font-size: 2.5rem; line-height: 1; display: inline-block; transform-origin: center center; }
        .facing-right { transform: scaleX(-1); }
        .facing-left { transform: scaleX(1); }
        @keyframes bob-transform { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-8px); } }
        .squirrel-inner { display: inline-block; transition: transform 0.3s; }
        .animate-bob { animation: bob-transform 1.5s infinite ease-in-out; }
        @keyframes collect-anim { 0% { transform: scale(1); } 50% { transform: scale(1.5) rotate(15deg); } 100% { transform: scale(1); } }
        .animate-collect { animation: collect-anim 0.5s ease-out; }
        
        /* Command Queue */
        .cmd-slot { transition: all 0.2s; border: 2px dashed #cbd5e1; background-color: white; aspect-ratio: 1/1; }
        .cmd-slot.filled { border: 2px solid #84cc16; background: #f7fee7; }
        .cmd-slot.repeat-block { border: 2px solid #db2777; background: #fbcfe8; }
        .cmd-slot.active { border-color: #fbbf24; box-shadow: 0 0 10px rgba(251, 191, 36, 0.6); transform: scale(1.1); z-index: 10; }

        /* Level Map */
        .level-scroll-container { overflow-x: auto; white-space: nowrap; -ms-overflow-style: none; scrollbar-width: none; }
        .level-scroll-container::-webkit-scrollbar { display: none; }
        .level-dot { width: 24px; height: 24px; border-radius: 50%; background-color: #cbd5e1; position: relative; z-index: 10; transition: all 0.3s; display: inline-flex; align-items: center; justify-content: center; font-size: 10px; color: white; font-weight: bold; cursor: pointer; margin: 0 4px; flex-shrink: 0; }
        .level-dot:hover { transform: scale(1.2); background-color: #94a3b8; }
        .level-dot.active { width: 32px; height: 32px; background-color: #fbbf24; box-shadow: 0 0 10px rgba(251, 191, 36, 0.5); transform: scale(1.2); cursor: default; }
        .level-dot.passed { background-color: #84cc16; }

        /* Tools & Scrollbar */
        .editor-highlight:hover { background-color: rgba(251, 191, 36, 0.3); border: 2px dashed #fbbf24; cursor: crosshair; }
        .tool-btn.active { background-color: #d9f99d; border-color: #65a30d; transform: scale(1.05); }
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: #f1f1f1; }
        ::-webkit-scrollbar-thumb { background: #a3e635; border-radius: 3px; }
        .detect-ring { transition: stroke-dashoffset 0.1s linear; transform: rotate(-90deg); transform-origin: 50% 50%; }
        .bg-grass { background-color: #a3e635; background-image: radial-gradient(#84cc16 15%, transparent 16%), radial-gradient(#84cc16 15%, transparent 16%); background-size: 20px 20px; background-position: 0 0, 10px 10px; }
        .collected-nut { opacity: 0.3; transform: scale(0.8); filter: grayscale(100%); }
        
        /* Manual Controls */
        .manual-btn { @apply bg-white border-2 border-lime-500 text-lime-700 rounded-lg hover:bg-lime-100 active:scale-95 transition shadow font-bold text-xl flex items-center justify-center; aspect-ratio: 1/1; }
    </style>
</head>
<body class="flex flex-col text-slate-800 w-full h-full">

    <!-- Audio Element for Custom BGM -->
    <audio id="bgm-audio" loop>
        <source src="bgm.mp3" type="audio/mpeg">
    </audio>

    <!-- Loading/Start Screen -->
    <div id="loading-screen" class="absolute inset-0 z-50 flex flex-col items-center justify-center bg-lime-50 p-4 text-center">
        <div id="start-btn-container" class="flex flex-col items-center animate-fade-in">
            <h1 class="text-4xl font-bold mb-4 text-lime-700">üêøÔ∏è Squirrel Coding</h1>
            <p class="text-slate-600 mb-6 max-w-md">‡∏Å‡∏î‡∏õ‡∏∏‡πà‡∏°‡∏î‡πâ‡∏≤‡∏ô‡∏•‡πà‡∏≤‡∏á‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÄ‡∏Å‡∏°<br><span class="text-xs text-slate-400">(‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏∞‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Å‡∏•‡πâ‡∏≠‡∏á‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥)</span></p>
            <button onclick="startApp()" class="px-8 py-4 bg-gradient-to-r from-lime-500 to-green-600 hover:from-lime-600 hover:to-green-700 text-white font-bold rounded-full text-xl shadow-lg transform hover:scale-105 transition-all animate-bounce">
                <i class="fas fa-play mr-2"></i> ‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÄ‡∏•‡∏¢!
            </button>
        </div>
        <div id="loading-spinner" class="hidden flex-col items-center">
            <div class="animate-spin rounded-full h-24 w-24 border-b-4 border-lime-500 mb-6"></div>
            <h2 class="text-2xl font-bold mb-2 text-lime-700">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...</h2>
        </div>
    </div>

    <!-- Main App Layout -->
    <div class="flex h-full w-full max-w-7xl mx-auto bg-white shadow-2xl overflow-hidden rounded-xl my-2 border-4 border-lime-200" style="min-height: 500px;">
        <!-- Left Panel -->
        <div class="flex-1 bg-lime-50 relative flex flex-col p-4 border-r-4 border-lime-200">
            <div class="bg-white p-3 rounded-2xl shadow-sm border border-lime-100 mb-2">
                <div class="flex justify-between items-center mb-2">
                    <h1 class="text-xl font-bold text-lime-800 flex items-center gap-2">
                        <span class="text-2xl">üå≤</span> <span id="level-title">‡∏î‡πà‡∏≤‡∏ô‡∏ó‡∏µ‡πà 1</span>
                    </h1>
                    <div class="flex gap-2">
                        <button id="editor-toggle-btn" onclick="toggleEditorMode()" class="px-3 py-1 bg-purple-500 hover:bg-purple-600 rounded-lg text-white text-xs transition font-bold shadow-md"><i class="fas fa-tools mr-1"></i>‡πÇ‡∏´‡∏°‡∏î‡∏Ñ‡∏£‡∏π</button>
                        <div class="w-px h-6 bg-slate-200 mx-1"></div>
                        <button id="music-btn" onclick="toggleMusic()" class="w-8 h-8 flex items-center justify-center bg-green-500 hover:bg-green-600 text-white rounded-full shadow transition text-xs"><i class="fas fa-volume-up"></i></button>
                        <button onclick="resetLevel()" class="px-3 py-1 bg-slate-400 hover:bg-slate-500 rounded-lg text-white text-xs transition font-bold"><i class="fas fa-undo mr-1"></i>‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÉ‡∏´‡∏°‡πà</button>
                    </div>
                </div>
                <div class="level-scroll-container px-1 py-2 flex items-center" id="level-map"></div>
            </div>

            <div id="editor-toolbar" class="hidden bg-purple-50 p-2 rounded-xl border-2 border-purple-200 mb-2 flex items-center justify-between animate-fade-in">
                <div class="flex items-center gap-2">
                    <span class="text-xs font-bold text-purple-700 mr-2">‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏°‡∏∑‡∏≠:</span>
                    <button onclick="selectTool('START')" id="tool-start" class="tool-btn w-10 h-10 rounded-lg border-2 border-transparent bg-white hover:bg-slate-50 flex items-center justify-center shadow-sm text-xl">üêøÔ∏è</button>
                    <button onclick="selectTool('NUT')" id="tool-nut" class="tool-btn w-10 h-10 rounded-lg border-2 border-transparent bg-white hover:bg-slate-50 flex items-center justify-center shadow-sm text-xl">üå∞</button>
                    <button onclick="selectTool('OBSTACLE')" id="tool-obstacle" class="tool-btn active w-10 h-10 rounded-lg border-2 border-transparent bg-white hover:bg-slate-50 flex items-center justify-center shadow-sm text-xl">ü™®</button>
                    <button onclick="selectTool('ERASE')" id="tool-erase" class="tool-btn w-10 h-10 rounded-lg border-2 border-transparent bg-white hover:bg-slate-50 flex items-center justify-center shadow-sm text-xl text-red-500">‚ùå</button>
                </div>
                <div class="flex items-center gap-2">
                    <button onclick="resizeGrid()" class="px-3 py-1.5 bg-white border border-purple-200 rounded-lg text-xs font-bold text-purple-700 hover:bg-purple-100"><i class="fas fa-expand mr-1"></i>‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏Ç‡∏ô‡∏≤‡∏î</button>
                </div>
            </div>

            <div class="flex-1 flex items-center justify-center p-2 relative">
                 <button id="run-btn" onclick="runCode()" class="absolute top-0 right-0 z-20 px-6 py-2 bg-gradient-to-r from-lime-500 to-green-600 hover:from-lime-600 hover:to-green-700 text-white font-bold rounded-xl shadow-lg transform hover:scale-105 transition disabled:opacity-50 disabled:cursor-not-allowed disabled:transform-none"><i class="fas fa-play mr-2"></i>RUN!</button>
                <div id="game-board-frame" class="bg-white p-4 rounded-3xl shadow-xl border-4 border-green-200 relative transition-colors duration-300">
                    <div class="absolute -top-6 -left-6 text-6xl transform -rotate-12 z-0 opacity-50">üåø</div>
                    <div class="absolute -bottom-6 -right-6 text-6xl transform rotate-12 z-0 opacity-50">üçÑ</div>
                    <div id="editor-overlay-text" class="hidden absolute -top-3 left-1/2 transform -translate-x-1/2 bg-purple-600 text-white text-xs px-3 py-1 rounded-full shadow-md z-30 font-bold">‡πÇ‡∏´‡∏°‡∏î‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç</div>
                    <div id="grid-container" class="grid gap-2 relative transition-all duration-300 z-10"></div>
                </div>
                <div id="win-overlay" class="absolute inset-0 z-30 bg-black/60 flex flex-col items-center justify-center hidden backdrop-blur-sm rounded-xl">
                    <div class="bg-white p-8 rounded-3xl text-center animate-bounce-sm shadow-2xl border-4 border-yellow-300 relative overflow-hidden max-w-sm w-full mx-4">
                        <h2 class="text-4xl font-bold text-green-600 mb-2">‡∏ú‡πà‡∏≤‡∏ô‡∏î‡πà‡∏≤‡∏ô! üéâ</h2>
                        <div class="flex justify-center my-4"><span class="text-6xl animate-pulse">‚≠ê</span></div>
                        <div class="flex flex-col items-center gap-4">
                            <div class="bg-lime-100 px-4 py-2 rounded-full border border-lime-300 animate-pulse"><span class="text-2xl mr-2">üëê</span> <span class="text-lime-800 font-bold text-sm">‡πÅ‡∏ö 2 ‡∏°‡∏∑‡∏≠ ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÑ‡∏õ‡∏ï‡πà‡∏≠</span></div>
                            <button onclick="nextLevel()" class="w-full py-3 bg-gradient-to-r from-yellow-400 to-orange-500 text-white rounded-full text-xl font-bold hover:shadow-lg hover:scale-105 transition border-b-4 border-orange-600 active:border-b-0 active:translate-y-1">‡∏î‡πà‡∏≤‡∏ô‡∏ñ‡∏±‡∏î‡πÑ‡∏õ ‚û°Ô∏è</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Right Panel -->
        <div class="w-80 md:w-96 bg-lime-100 flex flex-col relative border-l border-lime-200">
            <div class="relative w-full aspect-video bg-gray-900 border-b-4 border-lime-300 overflow-hidden group shadow-md">
                <video id="webcam" class="absolute inset-0 w-full h-full object-cover -z-10 opacity-0" autoplay playsinline muted></video>
                <canvas id="output-canvas" class="w-full h-full object-cover mirror-mode"></canvas>
                
                <div id="camera-feedback-overlay" class="absolute inset-0 flex items-center justify-center pointer-events-none">
                    <div id="gesture-feedback" class="text-center transform transition-all duration-200 opacity-0 scale-50">
                        <div class="relative w-24 h-24 flex items-center justify-center bg-white/20 backdrop-blur-md rounded-full shadow-lg">
                            <svg class="absolute inset-0 w-full h-full transform -rotate-90"><circle cx="48" cy="48" r="40" stroke="rgba(255,255,255,0.4)" stroke-width="6" fill="none"/><circle id="detect-progress" cx="48" cy="48" r="40" stroke="#bef264" stroke-width="6" fill="none" stroke-dasharray="251.2" stroke-dashoffset="251.2" class="detect-ring"/></svg>
                            <span id="gesture-icon" class="text-5xl drop-shadow-md">‚¨ÜÔ∏è</span>
                        </div>
                        <div id="gesture-text" class="text-lg font-bold text-lime-900 mt-2 bg-white/90 px-3 py-1 rounded-full shadow-sm inline-block">‡πÄ‡∏î‡∏¥‡∏ô‡∏´‡∏ô‡πâ‡∏≤</div>
                    </div>
                </div>
                <div class="absolute top-2 right-2 bg-white/80 px-2 py-1 rounded-full text-xs text-lime-800 font-bold shadow-sm">
                    <i id="camera-status-icon" class="fas fa-video mr-1"></i><span id="camera-status-text">Camera</span>
                </div>

                <!-- Manual Control Overlay -->
                <div id="manual-control-overlay" class="absolute inset-0 bg-lime-50 z-20 hidden flex-col items-center justify-center p-2">
                    <div class="text-xs text-red-500 font-bold mb-2 bg-red-100 px-2 py-1 rounded text-center w-full">
                        <i class="fas fa-video-slash mr-1"></i>‡πÉ‡∏ä‡πâ‡πÇ‡∏´‡∏°‡∏î‡∏õ‡∏∏‡πà‡∏°‡∏Å‡∏î (Sites Blocked Camera)
                    </div>
                    <div class="grid grid-cols-4 gap-2 w-full max-w-xs">
                        <div class="col-span-1"></div>
                        <button class="manual-btn" onclick="manualInput('UP')">‚¨ÜÔ∏è</button>
                        <div class="col-span-1"></div>
                        <button class="manual-btn bg-red-50 border-red-400 text-red-600" onclick="manualInput('DELETE')">‚úä</button>
                        <button class="manual-btn" onclick="manualInput('LEFT')">‚¨ÖÔ∏è</button>
                        <button class="manual-btn" onclick="manualInput('DOWN')">‚¨áÔ∏è</button>
                        <button class="manual-btn" onclick="manualInput('RIGHT')">‚û°Ô∏è</button>
                        <button class="manual-btn bg-pink-50 border-pink-400 text-pink-600 font-mono" onclick="manualInput('REPEAT')">x2</button>
                        <div class="col-span-1"></div>
                        <button class="manual-btn bg-orange-50 border-orange-400 text-orange-600" onclick="manualInput('COLLECT')">üß∫</button>
                        <div class="col-span-2 flex items-center justify-center">
                             <button class="w-full h-10 bg-green-500 hover:bg-green-600 text-white rounded-lg font-bold shadow text-sm" onclick="manualInput('RUN')">üöÄ RUN</button>
                        </div>
                    </div>
                </div>
            </div>

            <div class="bg-lime-200 px-2 py-2 text-center shadow-inner">
                <div class="grid grid-cols-2 gap-1 text-[10px] md:text-xs text-lime-900 font-semibold text-left p-1">
                    <div class="bg-white/60 px-2 py-1 rounded flex items-center gap-1"><i class="fas fa-hand-point-up text-blue-600"></i> 1 ‡∏ô‡∏¥‡πâ‡∏ß = ‡∏ó‡∏¥‡∏®‡∏ó‡∏≤‡∏á</div>
                    <div class="bg-white/60 px-2 py-1 rounded flex items-center gap-1"><i class="fas fa-hand-peace text-purple-600"></i> 2 ‡∏ô‡∏¥‡πâ‡∏ß = ‡∏ã‡πâ‡∏≥ (x2)</div>
                    <div class="bg-white/60 px-2 py-1 rounded flex items-center gap-1"><i class="fas fa-hand-paper text-orange-600"></i> 5 ‡∏ô‡∏¥‡πâ‡∏ß = ‡πÄ‡∏Å‡πá‡∏ö‡∏Ç‡∏≠‡∏á</div>
                    <div class="bg-white/60 px-2 py-1 rounded flex items-center gap-1"><i class="fas fa-hand-rock text-red-600"></i> ‡∏Å‡∏≥‡∏°‡∏∑‡∏≠ = ‡∏•‡∏ö‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á</div>
                    <div class="bg-green-100/80 px-2 py-1 rounded col-span-2 border border-green-300 text-center"><i class="fas fa-hands text-green-700"></i> 2 ‡∏°‡∏∑‡∏≠: ‡πÅ‡∏ö=Run / ‡∏Å‡∏≥=Reset</div>
                </div>
            </div>

            <div class="flex-1 p-2 overflow-y-auto bg-white/50 flex flex-col">
                <div class="flex justify-between items-center mb-1">
                    <h3 class="text-lg font-bold text-lime-800">üìú ‡πÇ‡∏õ‡∏£‡πÅ‡∏Å‡∏£‡∏° (<span id="cmd-count">0</span>/16)</h3>
                    <div id="target-counter" class="text-xs bg-yellow-100 text-yellow-800 px-2 py-1 rounded-full font-bold hidden">‡πÄ‡∏Å‡πá‡∏ö‡∏ñ‡∏±‡πà‡∏ß: 0/2</div>
                </div>
                <div id="command-list" class="grid grid-cols-4 gap-1 mb-2"></div>
                <div class="grid grid-cols-2 gap-2 mt-auto">
                    <button onclick="removeLastCommand()" class="bg-red-100 hover:bg-red-200 text-red-600 border-2 border-red-200 py-2 rounded-xl flex items-center justify-center gap-1 transition font-bold text-sm"><i class="fas fa-backspace"></i> ‡∏•‡∏ö</button>
                    <button onclick="clearAllCommands()" class="bg-slate-200 hover:bg-slate-300 text-slate-600 border-2 border-slate-300 py-2 rounded-xl flex items-center justify-center gap-1 transition font-bold text-sm"><i class="fas fa-trash-alt"></i> ‡∏•‡πâ‡∏≤‡∏á</button>
                </div>
                <div class="text-[10px] text-slate-400 text-center mt-2 opacity-70 leading-tight">‡∏û‡∏á‡∏®‡∏Å‡∏£ ‡∏ö‡∏π‡∏£‡∏ì‡πÄ‡∏ó‡∏®<br>ICT Talent ‡πÇ‡∏£‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏ö‡πâ‡∏≤‡∏ô‡∏ï‡∏≠‡∏á ‡∏ô‡πà‡∏≤‡∏ô</div>
            </div>
        </div>
    </div>

    <script>
        const CONFIG = { detectionThreshold: 1500, maxCommands: 16 };
        let useSynth = false; 
        
        let LEVELS = [
            { id: 1, width: 4, height: 4, start: {x: 0, y: 1}, targets: [{x: 3, y: 1}], obstacles: [] },
            { id: 2, width: 4, height: 4, start: {x: 0, y: 3}, targets: [{x: 2, y: 1}], obstacles: [{x: 0, y: 1}, {x: 1, y: 1}] },
            { id: 3, width: 4, height: 4, start: {x: 0, y: 0}, targets: [{x: 2, y: 2}], obstacles: [{x: 1, y: 0}, {x: 0, y: 2}, {x: 2, y: 1}] },
            { id: 4, width: 5, height: 4, start: {x: 0, y: 2}, targets: [{x: 4, y: 2}], obstacles: [{x: 2, y: 1}, {x: 2, y: 2}, {x: 2, y: 3}] },
            { id: 5, width: 5, height: 5, start: {x: 0, y: 0}, targets: [{x: 4, y: 4}], obstacles: [{x: 1, y: 1}, {x: 2, y: 2}, {x: 3, y: 3}, {x: 0, y: 4}, {x: 4, y: 0}] },
            { id: 6, width: 5, height: 5, start: {x: 2, y: 4}, targets: [{x: 2, y: 0}], obstacles: [{x: 2, y: 3}, {x: 1, y: 2}, {x: 3, y: 2}, {x: 2, y: 1}] },
            { id: 7, width: 5, height: 5, start: {x: 0, y: 0}, targets: [{x: 4, y: 0}], obstacles: [{x: 1, y: 0}, {x: 2, y: 0}, {x: 3, y: 0}, {x: 1, y: 2}, {x: 2, y: 2}, {x: 3, y: 2}] },
            { id: 8, width: 5, height: 5, start: {x: 0, y: 4}, targets: [{x: 4, y: 0}], obstacles: [{x: 0, y: 3}, {x: 1, y: 4}, {x: 2, y: 2}, {x: 3, y: 1}, {x: 4, y: 2}] },
            { id: 9, width: 5, height: 5, start: {x: 2, y: 2}, targets: [{x: 4, y: 2}], obstacles: [{x: 3, y: 2}, {x: 3, y: 3}, {x: 2, y: 3}, {x: 1, y: 3}, {x: 1, y: 2}, {x: 1, y: 1}, {x: 2, y: 1}, {x: 3, y: 1}] },
            { id: 10, width: 5, height: 5, start: {x: 0, y: 4}, targets: [{x: 4, y: 0}], obstacles: [{x: 0, y: 3}, {x: 1, y: 3}, {x: 2, y: 1}, {x: 3, y: 1}, {x: 3, y: 2}, {x: 4, y: 3}] },
            { id: 11, width: 5, height: 5, start: {x: 2, y: 2}, targets: [{x: 0, y: 0}, {x: 4, y: 4}], obstacles: [] },
            { id: 12, width: 5, height: 5, start: {x: 0, y: 2}, targets: [{x: 4, y: 0}, {x: 4, y: 4}], obstacles: [{x: 2, y: 1}, {x: 2, y: 2}, {x: 2, y: 3}] },
            { id: 13, width: 5, height: 5, start: {x: 0, y: 0}, targets: [{x: 0, y: 4}, {x: 4, y: 0}], obstacles: [{x: 1, y: 1}, {x: 2, y: 2}, {x: 3, y: 3}] },
            { id: 14, width: 5, height: 5, start: {x: 2, y: 4}, targets: [{x: 0, y: 2}, {x: 4, y: 2}], obstacles: [{x: 2, y: 3}, {x: 2, y: 2}, {x: 2, y: 1}] },
            { id: 15, width: 5, height: 5, start: {x: 0, y: 0}, targets: [{x: 2, y: 2}, {x: 4, y: 4}], obstacles: [{x: 0, y: 1}, {x: 3, y: 4}] },
            { id: 16, width: 5, height: 5, start: {x: 2, y: 2}, targets: [{x: 0, y: 0}, {x: 0, y: 4}], obstacles: [{x: 1, y: 1}, {x: 1, y: 3}, {x: 3, y: 2}] },
            { id: 17, width: 5, height: 5, start: {x: 0, y: 4}, targets: [{x: 2, y: 0}, {x: 4, y: 4}], obstacles: [{x: 0, y: 3}, {x: 1, y: 2}, {x: 3, y: 2}, {x: 4, y: 3}] },
            { id: 18, width: 5, height: 5, start: {x: 4, y: 2}, targets: [{x: 0, y: 0}, {x: 0, y: 4}], obstacles: [{x: 3, y: 2}, {x: 2, y: 2}, {x: 1, y: 1}, {x: 1, y: 3}] },
            { id: 19, width: 5, height: 5, start: {x: 2, y: 2}, targets: [{x: 2, y: 0}, {x: 2, y: 4}], obstacles: [{x: 1, y: 1}, {x: 3, y: 1}, {x: 1, y: 3}, {x: 3, y: 3}] },
            { id: 20, width: 5, height: 5, start: {x: 0, y: 0}, targets: [{x: 4, y: 0}, {x: 4, y: 4}], obstacles: [{x: 1, y: 0}, {x: 3, y: 0}, {x: 2, y: 2}, {x: 1, y: 4}, {x: 3, y: 4}] }
        ];

        let state = {
            currentLevelIdx: 0,
            squirrelPos: {x: 0, y: 0},
            facing: 'right', 
            collectedTargets: [], 
            commands: [],
            isExecuting: false,
            isLevelComplete: false,
            detectedGesture: null,
            gestureStartTime: 0,
            isMusicPlaying: true,
            musicInterval: null,
            musicNoteIdx: 0,
            isEditorMode: false,
            editorTool: 'OBSTACLE',
            cameraActive: false,
            manualMode: false
        };

        const gridContainer = document.getElementById('grid-container');
        const cmdList = document.getElementById('command-list');
        const gestureFeedback = document.getElementById('gesture-feedback');
        const detectProgress = document.getElementById('detect-progress');
        const cmdCountLabel = document.getElementById('cmd-count');
        const levelMapContainer = document.getElementById('level-map');
        const targetCounter = document.getElementById('target-counter');
        const editorToolbar = document.getElementById('editor-toolbar');
        const editorToggleBtn = document.getElementById('editor-toggle-btn');
        const gameBoardFrame = document.getElementById('game-board-frame');
        const editorOverlayText = document.getElementById('editor-overlay-text');
        const manualControlOverlay = document.getElementById('manual-control-overlay');
        const bgmAudio = document.getElementById('bgm-audio');

        const circumference = detectProgress.r.baseVal.value * 2 * Math.PI;
        detectProgress.style.strokeDasharray = `${circumference} ${circumference}`;
        detectProgress.style.strokeDashoffset = circumference;

        function initLevel(levelIdx) {
            if (levelIdx < 0 || levelIdx >= LEVELS.length) return;
            state.currentLevelIdx = levelIdx;
            const level = LEVELS[levelIdx];
            state.squirrelPos = {...level.start};
            state.collectedTargets = [];
            state.commands = [];
            state.isExecuting = false;
            state.isLevelComplete = false;
            
            if (state.squirrelPos.x === 0) state.facing = 'right';
            else if (state.squirrelPos.x === level.width - 1) state.facing = 'left';
            else state.facing = (level.start.x < level.width / 2) ? 'right' : 'left';

            document.getElementById('level-title').innerText = `‡∏î‡πà‡∏≤‡∏ô‡∏ó‡∏µ‡πà ${level.id}`;
            document.getElementById('win-overlay').classList.add('hidden');
            document.getElementById('run-btn').disabled = false;
            editorToggleBtn.disabled = false;
            editorToggleBtn.classList.remove('opacity-50', 'cursor-not-allowed');

            if (level.targets.length > 1) {
                targetCounter.classList.remove('hidden');
                updateTargetCounter();
            } else {
                targetCounter.classList.add('hidden');
            }
            if (!state.isEditorMode) renderLevelMap();
            renderGrid();
            renderCommands();
        }

        function updateTargetCounter() {
            const level = LEVELS[state.currentLevelIdx];
            targetCounter.innerText = `‡πÄ‡∏Å‡πá‡∏ö‡∏ñ‡∏±‡πà‡∏ß: ${state.collectedTargets.length}/${level.targets.length}`;
            if (state.collectedTargets.length === level.targets.length) {
                targetCounter.classList.add('bg-green-100', 'text-green-800');
                targetCounter.classList.remove('bg-yellow-100', 'text-yellow-800');
            } else {
                targetCounter.classList.remove('bg-green-100', 'text-green-800');
                targetCounter.classList.add('bg-yellow-100', 'text-yellow-800');
            }
        }

        function renderLevelMap() {
            levelMapContainer.innerHTML = '';
            LEVELS.forEach((level, index) => {
                const dot = document.createElement('div');
                dot.className = `level-dot ${index === state.currentLevelIdx ? 'active' : ''} ${index < state.currentLevelIdx ? 'passed' : ''}`;
                dot.onclick = () => { if (!state.isExecuting) { playSound('click'); initLevel(index); } };
                if (index === state.currentLevelIdx) dot.innerHTML = 'üêøÔ∏è';
                else if (index < state.currentLevelIdx) dot.innerHTML = '‚úÖ';
                else dot.innerHTML = level.id;
                levelMapContainer.appendChild(dot);
            });
            setTimeout(() => { const activeDot = document.querySelector('.level-dot.active'); if(activeDot) activeDot.scrollIntoView({ behavior: 'smooth', inline: 'center', block: 'nearest' }); }, 100);
        }

        function renderGrid() {
            const level = LEVELS[state.currentLevelIdx];
            gridContainer.style.gridTemplateColumns = `repeat(${level.width}, minmax(0, 1fr))`;
            gridContainer.innerHTML = '';
            const cellSize = level.width > 4 ? 'h-14 w-14' : 'h-16 w-16';

            for(let y=0; y<level.height; y++) {
                for(let x=0; x<level.width; x++) {
                    const cell = document.createElement('div');
                    cell.className = `${cellSize} rounded-lg border-b-4 flex items-center justify-center relative grid-cell overflow-visible`;
                    if (state.isEditorMode) {
                        cell.classList.add('cursor-pointer', 'editor-highlight');
                        cell.onclick = () => handleEditorClick(x, y);
                    }
                    const isObstacle = level.obstacles.some(o => o.x === x && o.y === y);
                    const isStart = level.start.x === x && level.start.y === y;
                    const targetIdx = level.targets.findIndex(t => t.x === x && t.y === y);
                    const isTarget = targetIdx !== -1;
                    const isCollected = state.collectedTargets.includes(targetIdx);

                    if (isObstacle) {
                        cell.classList.add('bg-stone-300', 'border-stone-500');
                        const decor = (x+y)%2 === 0 ? 'ü™®' : 'ü™µ';
                        cell.innerHTML = `<span class="text-3xl drop-shadow-md select-none pointer-events-none">${decor}</span>`;
                    } else {
                        cell.classList.add('bg-grass', 'border-lime-600');
                        if ((x*y + x)% 5 === 0 && !isTarget && !isStart) {
                             const flower = document.createElement('span');
                             flower.innerText = 'üå∏';
                             flower.className = "absolute bottom-1 right-1 text-[10px] opacity-80 pointer-events-none";
                             cell.appendChild(flower);
                        }
                    }
                    if (isTarget) {
                        let nutClass = "text-3xl drop-shadow-md select-none pointer-events-none z-10 absolute";
                        if (!isCollected) nutClass += " animate-pulse";
                        if (isCollected) nutClass += " collected-nut";
                        cell.innerHTML += `<span id="target-${targetIdx}" class="${nutClass}">üå∞</span>`;
                    }
                    const facingClass = state.facing === 'right' ? 'facing-right' : 'facing-left';
                    if (state.isEditorMode) {
                         if (isStart) cell.innerHTML += `<div class="absolute inset-0 flex items-center justify-center z-20 pointer-events-none opacity-50 grayscale"><span class="text-3xl drop-shadow-2xl select-none ${facingClass}" style="display:inline-block">üêøÔ∏è</span></div>`;
                    } else {
                         if (state.squirrelPos.x === x && state.squirrelPos.y === y) {
                            const squirrelWrapper = document.createElement('div');
                            squirrelWrapper.className = "absolute inset-0 flex items-center justify-center squirrel-container z-20 pointer-events-none";
                            const squirrelBody = document.createElement('div');
                            squirrelBody.className = `squirrel-body animate-bob select-none`;
                            const squirrelInner = document.createElement('span');
                            squirrelInner.className = `squirrel-inner ${facingClass}`;
                            squirrelInner.innerText = 'üêøÔ∏è';
                            squirrelBody.appendChild(squirrelInner);
                            squirrelWrapper.appendChild(squirrelBody);
                            cell.appendChild(squirrelWrapper);
                        }
                    }
                    gridContainer.appendChild(cell);
                }
            }
        }

        function toggleEditorMode() {
            if (state.isExecuting) return;
            state.isEditorMode = !state.isEditorMode;
            if (state.isEditorMode) {
                editorToolbar.classList.remove('hidden');
                editorToggleBtn.innerHTML = '<i class="fas fa-check mr-1"></i>‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô';
                editorToggleBtn.classList.replace('bg-purple-500', 'bg-green-600');
                editorToggleBtn.classList.replace('hover:bg-purple-600', 'hover:bg-green-700');
                gameBoardFrame.classList.replace('border-green-200', 'border-purple-300');
                editorOverlayText.classList.remove('hidden');
                const level = LEVELS[state.currentLevelIdx];
                state.squirrelPos = {...level.start};
                state.collectedTargets = [];
                if (state.squirrelPos.x === 0) state.facing = 'right'; else if (state.squirrelPos.x === level.width - 1) state.facing = 'left';
            } else {
                editorToolbar.classList.add('hidden');
                editorToggleBtn.innerHTML = '<i class="fas fa-tools mr-1"></i>‡πÇ‡∏´‡∏°‡∏î‡∏Ñ‡∏£‡∏π';
                editorToggleBtn.classList.replace('bg-green-600', 'bg-purple-500');
                editorToggleBtn.classList.replace('hover:bg-green-700', 'hover:bg-purple-600');
                gameBoardFrame.classList.replace('border-purple-300', 'border-green-200');
                editorOverlayText.classList.add('hidden');
                initLevel(state.currentLevelIdx);
            }
            renderGrid();
        }

        function selectTool(tool) {
            state.editorTool = tool;
            document.querySelectorAll('.tool-btn').forEach(btn => btn.classList.remove('active'));
            document.getElementById(`tool-${tool.toLowerCase()}`).classList.add('active');
            playSound('click');
        }

        function resizeGrid() {
            const level = LEVELS[state.currentLevelIdx];
            if (level.width === 4) { level.width = 5; level.height = 5; } else { level.width = 4; level.height = 4; }
            if(level.start.x >= level.width) level.start.x = level.width -1;
            if(level.start.y >= level.height) level.start.y = level.height -1;
            level.targets = level.targets.filter(t => t.x < level.width && t.y < level.height);
            level.obstacles = level.obstacles.filter(o => o.x < level.width && o.y < level.height);
            renderGrid();
            playSound('pop');
        }

        function handleEditorClick(x, y) {
            const level = LEVELS[state.currentLevelIdx];
            const existingTargetIdx = level.targets.findIndex(t => t.x === x && t.y === y);
            const isObstacle = level.obstacles.some(o => o.x === x && o.y === y);
            const isStart = level.start.x === x && level.start.y === y;

            if (state.editorTool === 'ERASE') {
                if (existingTargetIdx !== -1) level.targets.splice(existingTargetIdx, 1);
                level.obstacles = level.obstacles.filter(o => o.x !== x || o.y !== y);
                playSound('click');
            }
            else if (state.editorTool === 'OBSTACLE') {
                if (isStart || existingTargetIdx !== -1) { playSound('error'); return; }
                if (!isObstacle) level.obstacles.push({x, y});
                playSound('pop');
            }
            else if (state.editorTool === 'START') {
                if (isObstacle || existingTargetIdx !== -1) { playSound('error'); return; }
                level.start = {x, y};
                if (x === 0) state.facing = 'right'; else if (x === level.width - 1) state.facing = 'left';
                playSound('jump');
            }
            else if (state.editorTool === 'NUT') {
                if (isStart || isObstacle) { playSound('error'); return; }
                if (existingTargetIdx === -1) { level.targets.push({x, y}); playSound('win'); }
            }
            renderGrid();
        }

        function renderCommands() {
            cmdList.innerHTML = '';
            cmdCountLabel.innerText = `${state.commands.length}`;
            for (let i = 0; i < CONFIG.maxCommands; i++) {
                const cmd = state.commands[i];
                const slot = document.createElement('div');
                slot.className = `cmd-slot rounded-lg flex flex-col items-center justify-center relative ${cmd ? 'filled shadow-sm' : 'bg-slate-50'}`;
                if (cmd === 'REPEAT') slot.classList.add('repeat-block');
                const num = document.createElement('span');
                num.className = "absolute top-0.5 left-1 text-[8px] text-slate-400 font-mono";
                num.innerText = i + 1;
                slot.appendChild(num);
                if (cmd) {
                    let symbol = "", isText = false;
                    switch(cmd) {
                        case 'UP': symbol = "‚¨ÜÔ∏è"; break;
                        case 'DOWN': symbol = "‚¨áÔ∏è"; break;
                        case 'LEFT': symbol = "‚¨ÖÔ∏è"; break;
                        case 'RIGHT': symbol = "‚û°Ô∏è"; break;
                        case 'COLLECT': symbol = "üß∫"; break;
                        case 'REPEAT': symbol = "x2"; isText = true; break;
                    }
                    const icon = document.createElement('span');
                    if (isText) icon.className = "text-xl font-black text-pink-700 font-mono";
                    else icon.className = "text-xl filter drop-shadow-sm";
                    icon.innerText = symbol;
                    slot.appendChild(icon);
                }
                cmdList.appendChild(slot);
            }
        }

        function addCommand(cmd) {
            ensureAudioContext();
            if (state.isExecuting || state.isEditorMode) return;
            if (cmd === 'REPEAT') {
                if (state.commands.length > 0 && state.commands.length < CONFIG.maxCommands) {
                    state.commands.push('REPEAT'); renderCommands(); playSound('pop');
                } else { playSound('error'); }
                return;
            }
            if (state.commands.length < CONFIG.maxCommands) {
                state.commands.push(cmd); renderCommands(); playSound('pop');
            } else { playSound('error'); }
        }

        function removeLastCommand() {
            ensureAudioContext();
            if (state.isExecuting || state.commands.length === 0 || state.isEditorMode) return;
            state.commands.pop(); renderCommands(); playSound('click');
        }

        function clearAllCommands() {
            ensureAudioContext();
            if (state.isExecuting || state.isEditorMode) return;
            state.commands = []; renderCommands(); playSound('click');
        }

        async function runCode() {
            ensureAudioContext();
            if (state.isEditorMode) { alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡πÇ‡∏´‡∏°‡∏î‡∏Ñ‡∏£‡∏π‡∏Å‡πà‡∏≠‡∏ô‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÄ‡∏•‡πà‡∏ô"); return; }
            if (state.commands.length === 0) return;
            
            try {
                state.isExecuting = true;
                document.getElementById('run-btn').disabled = true;
                if(state.manualMode) document.querySelector('button[onclick="manualInput(\'RUN\')"]').disabled = true;
                editorToggleBtn.disabled = true;
                editorToggleBtn.classList.add('opacity-50', 'cursor-not-allowed');
                
                const level = LEVELS[state.currentLevelIdx];
                state.squirrelPos = {...level.start};
                state.collectedTargets = [];
                if (state.squirrelPos.x === 0) state.facing = 'right'; else if (state.squirrelPos.x === level.width - 1) state.facing = 'left'; else state.facing = (level.start.x < level.width / 2) ? 'right' : 'left';
                
                updateTargetCounter(); renderGrid(); await wait(600);

                for (let i = 0; i < state.commands.length; i++) {
                    if (!state.isExecuting) break;
                    const slots = document.querySelectorAll('.cmd-slot');
                    slots.forEach(s => s.classList.remove('active'));
                    if(slots[i]) slots[i].classList.add('active');
                    
                    const cmd = state.commands[i];
                    let action = cmd;
                    if (cmd === 'REPEAT') {
                        let lookBackIdx = i - 1;
                        while (lookBackIdx >= 0 && state.commands[lookBackIdx] === 'REPEAT') lookBackIdx--;
                        if (lookBackIdx >= 0) action = state.commands[lookBackIdx]; else action = null; 
                    }

                    if (action) {
                        if (action === 'COLLECT') await attemptCollect(); else await moveSquirrel(action);
                    }
                    if (checkWin()) {
                        playMelody('win');
                        document.getElementById('win-overlay').classList.remove('hidden');
                        state.isExecuting = false;
                        state.isLevelComplete = true; 
                        return;
                    }
                }
            } catch (e) { console.error(e); } finally {
                if (!state.isLevelComplete) state.isExecuting = false;
                document.getElementById('run-btn').disabled = false;
                if(state.manualMode) document.querySelector('button[onclick="manualInput(\'RUN\')"]').disabled = false;
                editorToggleBtn.disabled = false;
                editorToggleBtn.classList.remove('opacity-50', 'cursor-not-allowed');
                document.querySelectorAll('.cmd-slot').forEach(s => s.classList.remove('active'));
            }
        }

        async function attemptCollect() {
             const level = LEVELS[state.currentLevelIdx];
             const targetIdx = level.targets.findIndex(t => t.x === state.squirrelPos.x && t.y === state.squirrelPos.y);
             const squirrelBody = document.querySelector('.squirrel-body');
             if(squirrelBody) {
                 squirrelBody.classList.remove('animate-bob'); squirrelBody.classList.add('animate-collect');
                 setTimeout(() => { squirrelBody.classList.remove('animate-collect'); squirrelBody.classList.add('animate-bob'); }, 500);
             }
             if (targetIdx !== -1 && !state.collectedTargets.includes(targetIdx)) {
                 state.collectedTargets.push(targetIdx); playSound('pop'); updateTargetCounter(); renderGrid();
             } else { playSound('error'); }
             await wait(600);
        }

        async function moveSquirrel(direction) {
            const level = LEVELS[state.currentLevelIdx];
            let newX = state.squirrelPos.x;
            let newY = state.squirrelPos.y;
            if (direction === 'RIGHT') state.facing = 'right'; if (direction === 'LEFT') state.facing = 'left';
            if (direction === 'UP') newY--; if (direction === 'DOWN') newY++;
            if (direction === 'LEFT') newX--; if (direction === 'RIGHT') newX++;
            
            let hit = false;
            if (newX < 0 || newX >= level.width || newY < 0 || newY >= level.height) hit = true;
            else if (level.obstacles.some(o => o.x === newX && o.y === newY)) hit = true;
            
            if (hit) {
                playSound('bump');
                gridContainer.classList.add('translate-x-2');
                setTimeout(() => gridContainer.classList.remove('translate-x-2'), 100);
                renderGrid();
            } else {
                state.squirrelPos = {x: newX, y: newY}; playSound('jump');
                if (level.targets.length === 1) {
                    const targetIdx = level.targets.findIndex(t => t.x === newX && t.y === newY);
                    if (targetIdx !== -1 && !state.collectedTargets.includes(targetIdx)) {
                        state.collectedTargets.push(targetIdx); playSound('pop'); updateTargetCounter();
                    }
                }
                renderGrid();
            }
            await wait(800);
        }

        function checkWin() { return state.collectedTargets.length === LEVELS[state.currentLevelIdx].targets.length; }
        function nextLevel() { ensureAudioContext(); if (state.currentLevelIdx < LEVELS.length - 1) initLevel(state.currentLevelIdx + 1); else { alert("‡∏¢‡∏¥‡∏ô‡∏î‡∏µ‡∏î‡πâ‡∏ß‡∏¢! ‡∏Ñ‡∏∏‡∏ì‡∏Ñ‡∏∑‡∏≠‡∏™‡∏∏‡∏î‡∏¢‡∏≠‡∏î‡πÇ‡∏õ‡∏£‡πÅ‡∏Å‡∏£‡∏°‡πÄ‡∏°‡∏≠‡∏£‡πå‡πÅ‡∏´‡πà‡∏á‡∏õ‡πà‡∏≤!"); initLevel(0); } }
        function resetLevel() { ensureAudioContext(); initLevel(state.currentLevelIdx); }
        function wait(ms) { return new Promise(r => setTimeout(r, ms)); }

        // --- Manual Input Mode ---
        function activateManualMode() {
            console.warn("Camera failed. Switching to Manual Mode.");
            state.manualMode = true;
            document.getElementById('start-btn-container').classList.add('hidden');
            document.getElementById('loading-spinner').classList.add('hidden');
            document.getElementById('loading-screen').classList.add('hidden');
            
            // Show manual UI
            manualControlOverlay.classList.remove('hidden');
            manualControlOverlay.style.display = 'flex';
            document.getElementById('camera-status-text').innerText = "Manual Mode";
            document.getElementById('camera-status-icon').className = "fas fa-keyboard mr-1";
            document.getElementById('camera-feedback-overlay').classList.add('hidden');
            
            initLevel(0);
        }

        function manualInput(cmd) {
            if (cmd === 'RUN') {
                if (state.isLevelComplete) nextLevel(); else runCode();
            } else if (cmd === 'DELETE') {
                removeLastCommand();
            } else {
                addCommand(cmd);
            }
        }

        // --- Audio & Vision ---
        const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        
        function ensureAudioContext() { 
            if (audioCtx.state === 'suspended') audioCtx.resume(); 
            // Fix: Check if synth is needed before starting loop
            if (state.isMusicPlaying) {
                if (useSynth) {
                    if (!state.musicInterval) startMusicLoop();
                } else {
                    if (bgmAudio.paused) playBackgroundMusic();
                }
            }
        }

        function playSound(type) {
            if (audioCtx.state === 'suspended') audioCtx.resume();
            const now = audioCtx.currentTime;
            
            // Common nodes
            const osc = audioCtx.createOscillator();
            const gain = audioCtx.createGain();
            osc.connect(gain);
            gain.connect(audioCtx.destination);

            if (type === 'pop') { // Coin/Collect Sound - "Ding!"
                osc.type = 'sine';
                osc.frequency.setValueAtTime(1200, now);
                osc.frequency.exponentialRampToValueAtTime(2000, now + 0.1);
                gain.gain.setValueAtTime(0.3, now);
                gain.gain.exponentialRampToValueAtTime(0.01, now + 0.3);
                osc.start(now);
                osc.stop(now + 0.3);
                
                // Add a second harmonic for sparkle
                const osc2 = audioCtx.createOscillator();
                const gain2 = audioCtx.createGain();
                osc2.connect(gain2);
                gain2.connect(audioCtx.destination);
                osc2.type = 'triangle';
                osc2.frequency.setValueAtTime(2400, now);
                gain2.gain.setValueAtTime(0.1, now);
                gain2.gain.exponentialRampToValueAtTime(0.01, now + 0.3);
                osc2.start(now);
                osc2.stop(now + 0.3);

            } else if (type === 'jump') { // Move Sound - "Bloop"
                osc.type = 'triangle';
                osc.frequency.setValueAtTime(300, now);
                osc.frequency.linearRampToValueAtTime(500, now + 0.1);
                gain.gain.setValueAtTime(0.2, now);
                gain.gain.linearRampToValueAtTime(0, now + 0.15);
                osc.start(now);
                osc.stop(now + 0.15);

            } else if (type === 'bump') { // Obstacle - "Thud"
                osc.type = 'square';
                osc.frequency.setValueAtTime(150, now);
                osc.frequency.exponentialRampToValueAtTime(40, now + 0.2);
                gain.gain.setValueAtTime(0.2, now);
                gain.gain.exponentialRampToValueAtTime(0.01, now + 0.2);
                osc.start(now);
                osc.stop(now + 0.2);

            } else if (type === 'click') { // UI Click
                osc.type = 'sine';
                osc.frequency.setValueAtTime(800, now);
                gain.gain.setValueAtTime(0.1, now);
                gain.gain.exponentialRampToValueAtTime(0.01, now + 0.05);
                osc.start(now);
                osc.stop(now + 0.05);

            } else if (type === 'error') { // Error - "Buzz"
                osc.type = 'sawtooth';
                osc.frequency.setValueAtTime(150, now);
                osc.frequency.linearRampToValueAtTime(100, now + 0.3);
                gain.gain.setValueAtTime(0.2, now);
                gain.gain.linearRampToValueAtTime(0, now + 0.3);
                osc.start(now);
                osc.stop(now + 0.3);
            }
        }

        // Fun Melody
        const MELODY_SEQ = [
            // Happy Pentatonic Pattern
            523.25, 0, 659.25, 0, 783.99, 0, 1046.50, 0, // C E G C
            783.99, 0, 659.25, 0, 523.25, 0, 392.00, 0,  // G E C G
            440.00, 0, 523.25, 0, 587.33, 0, 783.99, 0,  // A C D G
            523.25, 523.25, 0, 0                         // C C
        ];
        
        function startMusicLoop() {
            if (audioCtx.state === 'suspended') audioCtx.resume();
            if (state.musicInterval) clearInterval(state.musicInterval);
            state.musicNoteIdx = 0;
            state.musicInterval = setInterval(() => {
                const freq = MELODY_SEQ[state.musicNoteIdx];
                if (freq > 0) {
                    const osc = audioCtx.createOscillator();
                    const gain = audioCtx.createGain();
                    osc.type = 'triangle'; // Softer, flute-like
                    osc.connect(gain);
                    gain.connect(audioCtx.destination);
                    const now = audioCtx.currentTime;
                    
                    osc.frequency.value = freq;
                    // Envelope for "plucky" sound
                    gain.gain.setValueAtTime(0.05, now); // Lower volume for background
                    gain.gain.exponentialRampToValueAtTime(0.001, now + 0.15);
                    
                    osc.start(now);
                    osc.stop(now + 0.2);
                }
                state.musicNoteIdx = (state.musicNoteIdx + 1) % MELODY_SEQ.length;
            }, 200); // BPM Control
        }

        // Win Fanfare
        function playMelody(type) {
             if (type === 'win') {
                const now = audioCtx.currentTime;
                // Arpeggio C Major
                [523.25, 659.25, 783.99, 1046.50, 1318.51, 1567.98].forEach((freq, i) => {
                    const osc = audioCtx.createOscillator();
                    const gain = audioCtx.createGain();
                    osc.connect(gain);
                    gain.connect(audioCtx.destination);
                    osc.type = 'square'; // 8-bit style
                    osc.frequency.value = freq;
                    
                    const startTime = now + (i * 0.1);
                    gain.gain.setValueAtTime(0.1, startTime);
                    gain.gain.exponentialRampToValueAtTime(0.01, startTime + 0.3);
                    
                    osc.start(startTime);
                    osc.stop(startTime + 0.3);
                });
             }
        }

        function playBackgroundMusic() {
            if (!state.isMusicPlaying) return;
            
            if (useSynth) {
                startMusicLoop();
            } else {
                // Attempt to play MP3
                bgmAudio.volume = 0.5; // Set volume to 50%
                bgmAudio.play().catch(e => {
                    console.error("BGM load failed, switching to synth:", e);
                    useSynth = true;
                    startMusicLoop();
                });
            }
        }

        function toggleMusic() {
            state.isMusicPlaying = !state.isMusicPlaying;
            const btn = document.getElementById('music-btn');
            
            // Handle Custom MP3 Logic
            if (state.isMusicPlaying) {
                btn.classList.replace('bg-pink-400', 'bg-green-500');
                btn.innerHTML = '<i class="fas fa-volume-up"></i>';
                playBackgroundMusic();
            } else {
                btn.classList.replace('bg-green-500', 'bg-pink-400');
                btn.innerHTML = '<i class="fas fa-volume-mute"></i>';
                bgmAudio.pause();
                stopMusicLoop();
            }
        }
        
        function stopMusicLoop() { if (state.musicInterval) clearInterval(state.musicInterval); state.musicInterval = null; }

        function onResults(results) {
            if (!state.cameraActive) { state.cameraActive = true; document.getElementById('loading-screen').classList.add('hidden'); }
            const ctx = document.getElementById('output-canvas').getContext('2d');
            const canvas = document.getElementById('output-canvas');
            ctx.save(); ctx.clearRect(0, 0, canvas.width, canvas.height); ctx.drawImage(results.image, 0, 0, canvas.width, canvas.height);
            if (results.multiHandLandmarks && results.multiHandLandmarks.length > 0) {
                for (const landmarks of results.multiHandLandmarks) { drawConnectors(ctx, landmarks, HAND_CONNECTIONS, {color: '#bef264', lineWidth: 3}); drawLandmarks(ctx, landmarks, {color: '#84cc16', lineWidth: 1}); }
                if (results.multiHandLandmarks.length === 2) {
                    const hand1Open = isOpenPalm(results.multiHandLandmarks[0]);
                    const hand2Open = isOpenPalm(results.multiHandLandmarks[1]);
                    const hand1Fist = isFist(results.multiHandLandmarks[0]);
                    const hand2Fist = isFist(results.multiHandLandmarks[1]);
                    if (hand1Open && hand2Open) {
                        if (state.isLevelComplete) handleGestureConfirm('NEXT_LEVEL', '‚û°Ô∏è', '‡∏î‡πà‡∏≤‡∏ô‡∏ñ‡∏±‡∏î‡πÑ‡∏õ'); else handleGestureConfirm('RUN', 'üöÄ', '‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ó‡∏≥‡∏á‡∏≤‡∏ô (RUN)');
                    } else if (hand1Fist && hand2Fist) { handleGestureConfirm('RESET', 'üîÑ', '‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÄ‡∏Å‡∏°‡πÉ‡∏´‡∏°‡πà'); } else { resetGestureTimer(); }
                } 
                else if (results.multiHandLandmarks.length === 1) {
                    if ((!state.isExecuting || state.isLevelComplete) && !state.isEditorMode) processGesture(results.multiHandLandmarks[0]);
                }
            } else { resetGestureTimer(); }
            ctx.restore();
        }

        function isFingerExtended(landmarks, tipIdx, pipIdx) { const wrist = landmarks[0]; const tip = landmarks[tipIdx]; const pip = landmarks[pipIdx]; return Math.sqrt(Math.pow(tip.x - wrist.x, 2) + Math.pow(tip.y - wrist.y, 2)) > Math.sqrt(Math.pow(pip.x - wrist.x, 2) + Math.pow(pip.y - wrist.y, 2)); }
        function isOpenPalm(landmarks) { return isFingerExtended(landmarks, 8, 6) && isFingerExtended(landmarks, 12, 10) && isFingerExtended(landmarks, 16, 14) && isFingerExtended(landmarks, 20, 18); }
        function isFist(landmarks) { return !isFingerExtended(landmarks, 8, 6) && !isFingerExtended(landmarks, 12, 10) && !isFingerExtended(landmarks, 16, 14) && !isFingerExtended(landmarks, 20, 18); }

        function processGesture(landmarks) {
            const index = isFingerExtended(landmarks, 8, 6); const middle = isFingerExtended(landmarks, 12, 10); const ring = isFingerExtended(landmarks, 16, 14); const pinky = isFingerExtended(landmarks, 20, 18);
            let gesture = null, icon = "", text = "";
            if (!index && !middle && !ring && !pinky) { gesture = 'DELETE'; icon = '‚úä'; text = "‡∏•‡∏ö‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á"; } 
            else if (index && middle && ring && pinky) { if (state.isLevelComplete) { gesture = 'NEXT_LEVEL'; icon = '‚û°Ô∏è'; text = "‡∏î‡πà‡∏≤‡∏ô‡∏ñ‡∏±‡∏î‡πÑ‡∏õ"; } else { gesture = 'COLLECT'; icon = 'üß∫'; text = "‡πÄ‡∏Å‡πá‡∏ö‡∏Ç‡∏≠‡∏á"; } }
            else if (index && middle && !ring && !pinky) { gesture = 'REPEAT'; icon = '‚úåÔ∏è'; text = "‡∏ó‡∏≥‡∏ã‡πâ‡∏≥ (x2)"; }
            else if (index && !middle && !ring && !pinky) {
                const dx = landmarks[8].x - landmarks[0].x; const dy = landmarks[8].y - landmarks[0].y;
                if (Math.abs(dx) > Math.abs(dy)) { if (dx < -0.1) { gesture = 'RIGHT'; icon = '‚û°Ô∏è'; text = "‡πÑ‡∏õ‡∏Ç‡∏ß‡∏≤"; } else if (dx > 0.1) { gesture = 'LEFT'; icon = '‚¨ÖÔ∏è'; text = "‡πÑ‡∏õ‡∏ã‡πâ‡∏≤‡∏¢"; } }
                else { if (dy < -0.1) { gesture = 'UP'; icon = '‚¨ÜÔ∏è'; text = "‡πÄ‡∏î‡∏¥‡∏ô‡∏´‡∏ô‡πâ‡∏≤"; } else if (dy > 0.1) { gesture = 'DOWN'; icon = '‚¨áÔ∏è'; text = "‡∏ñ‡∏≠‡∏¢‡∏´‡∏•‡∏±‡∏á"; } }
            }
            if (gesture) handleGestureConfirm(gesture, icon, text); else resetGestureTimer();
        }

        function handleGestureConfirm(gesture, icon, text) {
            const now = Date.now();
            if (gesture === state.detectedGesture) {
                const elapsed = now - state.gestureStartTime;
                updateFeedback(true, icon, text, elapsed);
                if (elapsed >= CONFIG.detectionThreshold) {
                    if (gesture === 'RESET') resetLevel();
                    else if (gesture === 'RUN') runCode();
                    else if (gesture === 'NEXT_LEVEL') nextLevel();
                    else if (gesture === 'DELETE') removeLastCommand();
                    else addCommand(gesture);
                    resetGestureTimer(); state.detectedGesture = null;
                }
            } else { state.detectedGesture = gesture; state.gestureStartTime = now; updateFeedback(true, icon, text, 0); }
        }

        function resetGestureTimer() { state.detectedGesture = null; state.gestureTimer = 0; updateFeedback(false); }
        function updateFeedback(show, icon, text, timer) {
            if (show) {
                gestureFeedback.classList.remove('opacity-0', 'scale-50'); gestureFeedback.classList.add('opacity-100', 'scale-100');
                document.getElementById('gesture-icon').innerText = icon; document.getElementById('gesture-text').innerText = text;
                const percent = Math.min(1, timer / CONFIG.detectionThreshold);
                detectProgress.style.strokeDashoffset = circumference - (percent * circumference);
            } else { gestureFeedback.classList.add('opacity-0', 'scale-50'); gestureFeedback.classList.remove('opacity-100', 'scale-100'); }
        }

        async function startApp() {
            document.getElementById('start-btn-container').classList.add('hidden');
            document.getElementById('loading-spinner').classList.remove('hidden');
            document.getElementById('loading-spinner').style.display = 'flex';
            
            // --- FIX: Trigger Audio Immediately ---
            if (audioCtx.state === 'suspended') {
                audioCtx.resume();
            }
            
            if (state.isMusicPlaying) {
                playBackgroundMusic();
            }
            // ---------------------------------------

            const videoElement = document.getElementById('webcam');
            const canvasElement = document.getElementById('output-canvas');
            
            const hands = new Hands({locateFile: (file) => `https://cdn.jsdelivr.net/npm/@mediapipe/hands/${file}`});
            hands.setOptions({ maxNumHands: 2, modelComplexity: 1, minDetectionConfidence: 0.6, minTrackingConfidence: 0.5 });
            hands.onResults(onResults);
            
            const camera = new Camera(videoElement, { onFrame: async () => { await hands.send({image: videoElement}); }, width: 640, height: 360 });
            
            try { 
                await camera.start(); 
                canvasElement.width = 640; canvasElement.height = 360; 
                
                initLevel(0); 
            } catch (e) { 
                activateManualMode();
            }
        }
    </script>
</body>
</html>
